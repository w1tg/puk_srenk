<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZeroPayGPT - LaTeX Viewer</title>
    
    <!-- MathJax –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ LaTeX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    
    <!-- Highlight.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--tg-theme-text-color, #000);
            background-color: var(--tg-theme-bg-color, #fff);
            padding: 16px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        
        .logo {
            font-size: 18px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000);
        }
        
        .status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }
        
        .content {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ */
        .math-inline {
            color: var(--tg-theme-link-color, #3390ec);
            padding: 0 4px;
        }
        
        .math-block {
            margin: 16px 0;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–¥–∞ */
        pre {
            margin: 16px 0;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 14px;
        }
        
        /* Inline –∫–æ–¥ */
        p code, li code {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
        h1, h2, h3, h4, h5, h6 {
            margin: 20px 0 12px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        h1 { font-size: 24px; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; }
        h4 { font-size: 16px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ */
        ul, ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        li {
            margin: 4px 0;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ */
        a {
            color: var(--tg-theme-link-color, #3390ec);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ü–∏—Ç–∞—Ç */
        blockquote {
            margin: 16px 0;
            padding: 12px 16px;
            border-left: 4px solid var(--tg-theme-hint-color, #999);
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-radius: 4px;
        }
        
        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
        hr {
            margin: 20px 0;
            border: none;
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        table {
            width: 100%;
            margin: 16px 0;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        
        th {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            font-weight: 600;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */
        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        pre:hover .copy-button {
            opacity: 1;
        }
        
        .copy-button:active {
            transform: scale(0.95);
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö */
        .error {
            padding: 16px;
            background: #fee;
            color: #c33;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #fcc;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999);
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid var(--tg-theme-hint-color, #999);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            body {
                padding: 12px;
            }
            
            h1 { font-size: 20px; }
            h2 { font-size: 18px; }
            h3 { font-size: 16px; }
            
            pre {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ü§ñ ZeroPayGPT</div>
            <div class="status">LaTeX Viewer</div>
        </div>
        
        <div id="content" class="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</div>
        </div>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'no-mathjax'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax –≥–æ—Ç–æ–≤');
                    });
                }
            }
        };
        
        // –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        class ContentProcessor {
            constructor() {
                this.contentEl = document.getElementById('content');
            }
            
            async init() {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const encodedData = urlParams.get('data');
                    
                    if (!encodedData) {
                        throw new Error('–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    }
                    
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                    const decodedData = this.decodeData(encodedData);
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    await this.processContent(decodedData);
                    
                } catch (error) {
                    this.showError(error.message);
                }
            }
            
            decodeData(encodedData) {
                try {
                    // URL decode -> Base64 decode -> UTF-8 decode
                    const base64 = decodeURIComponent(encodedData);
                    const bytes = atob(base64);
                    const text = decodeURIComponent(escape(bytes));
                    return text;
                } catch (e) {
                    throw new Error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                }
            }
            
            async processContent(text) {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ HTML
                const html = this.markdownToHtml(text);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                this.contentEl.innerHTML = html;
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥
                this.highlightCode();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                this.addCopyButtons();
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
                await this.renderMath();
            }
            
            markdownToHtml(markdown) {
                let html = markdown;
                
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML
                html = html.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
                const codeBlocks = [];
                html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                    const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                    codeBlocks.push({ lang: lang || 'plaintext', code: code.trim() });
                    return placeholder;
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º inline –∫–æ–¥
                const inlineCodes = [];
                html = html.replace(/`([^`]+)`/g, (match, code) => {
                    const placeholder = `__INLINE_CODE_${inlineCodes.length}__`;
                    inlineCodes.push(code);
                    return placeholder;
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
                const mathBlocks = [];
                const mathInlines = [];
                
                // –ë–ª–æ—á–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
                html = html.replace(/\\\[([\s\S]*?)\\\]/g, (match, math) => {
                    const placeholder = `__MATH_BLOCK_${mathBlocks.length}__`;
                    mathBlocks.push(math);
                    return placeholder;
                });
                
                html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                    const placeholder = `__MATH_BLOCK_${mathBlocks.length}__`;
                    mathBlocks.push(math);
                    return placeholder;
                });
                
                // –ò–Ω–ª–∞–π–Ω –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞
                html = html.replace(/\\\((.*?)\\\)/g, (match, math) => {
                    const placeholder = `__MATH_INLINE_${mathInlines.length}__`;
                    mathInlines.push(math);
                    return placeholder;
                });
                
                html = html.replace(/\$([^$\n]+)\$/g, (match, math) => {
                    const placeholder = `__MATH_INLINE_${mathInlines.length}__`;
                    mathInlines.push(math);
                    return placeholder;
                });
                
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
                html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
                html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
                html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
                html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
                html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
                
                // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
                
                // –ö—É—Ä—Å–∏–≤
                html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
                
                // –ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π
                html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');
                
                // –°–ø–∏—Å–∫–∏
                html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
                html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
                html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
                
                // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞
                html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                    return '<ul>' + match + '</ul>';
                });
                
                // –¶–∏—Ç–∞—Ç—ã
                html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                html = html.replace(/^---+$/gm, '<hr>');
                
                // –°—Å—ã–ª–∫–∏
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã
                html = html.replace(/\n\n/g, '</p><p>');
                html = '<p>' + html + '</p>';
                
                // –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤
                html = html.replace(/<p>\s*<\/p>/g, '');
                html = html.replace(/<p>(<h[1-6]>)/g, '$1');
                html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
                html = html.replace(/<p>(<ul>)/g, '$1');
                html = html.replace(/(<\/ul>)<\/p>/g, '$1');
                html = html.replace(/<p>(<blockquote>)/g, '$1');
                html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
                html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–¥
                codeBlocks.forEach((block, i) => {
                    const codeHtml = `<pre><code class="language-${block.lang} no-mathjax">${this.escapeHtml(block.code)}</code></pre>`;
                    html = html.replace(`__CODE_BLOCK_${i}__`, codeHtml);
                });
                
                inlineCodes.forEach((code, i) => {
                    html = html.replace(`__INLINE_CODE_${i}__`, `<code class="no-mathjax">${this.escapeHtml(code)}</code>`);
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
                mathBlocks.forEach((math, i) => {
                    html = html.replace(`__MATH_BLOCK_${i}__`, `<div class="math-block">\\[${math}\\]</div>`);
                });
                
                mathInlines.forEach((math, i) => {
                    html = html.replace(`__MATH_INLINE_${i}__`, `<span class="math-inline">\\(${math}\\)</span>`);
                });
                
                return html;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            highlightCode() {
                document.querySelectorAll('pre code').forEach((block) => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–ª–æ–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º no-mathjax (–æ–Ω–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
                    if (!block.classList.contains('no-mathjax')) {
                        hljs.highlightElement(block);
                    } else {
                        // –î–ª—è –±–ª–æ–∫–æ–≤ —Å no-mathjax –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                        hljs.highlightElement(block);
                    }
                });
            }
            
            addCopyButtons() {
                document.querySelectorAll('pre').forEach((pre) => {
                    const button = document.createElement('button');
                    button.className = 'copy-button';
                    button.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    button.onclick = () => this.copyCode(pre, button);
                    pre.style.position = 'relative';
                    pre.appendChild(button);
                });
            }
            
            async copyCode(pre, button) {
                const code = pre.querySelector('code');
                const text = code.textContent;
                
                try {
                    await navigator.clipboard.writeText(text);
                    button.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                    setTimeout(() => {
                        button.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    }, 2000);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    button.textContent = '‚úó –û—à–∏–±–∫–∞';
                    setTimeout(() => {
                        button.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    }, 2000);
                }
            }
            
            async renderMath() {
                try {
                    await MathJax.typesetPromise();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏:', err);
                }
            }
            
            showError(message) {
                this.contentEl.innerHTML = `
                    <div class="error">
                        <strong>–û—à–∏–±–∫–∞:</strong> ${message}
                    </div>
                `;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            const processor = new ContentProcessor();
            processor.init();
        });
    </script>
</body>
</html>
